#include QMK_KEYBOARD_H

// Used to create a keymap using only KC_ prefixed keys
#define LAYOUT_ortho_5x15_kc( \
    L00, L01, L02, L03, L04, L05, L06, M0, R00, R01, R02, R03, R04, R05, R06, \
    L10, L11, L12, L13, L14, L15, L16, M1, R10, R11, R12, R13, R14, R15, R16, \
    L20, L21, L22, L23, L24, L25, L26, M2, R20, R21, R22, R23, R24, R25, R26, \
    L30, L31, L32, L33, L34, L35, L36, M3, R30, R31, R32, R33, R34, R35, R36, \
    L40, L41, L42, L43, L44, L45, L46, M4, R40, R41, R42, R43, R44, R45, R46 \
    ) \
    LAYOUT_ortho_5x15( \
    KC_##L00, KC_##L01, KC_##L02, KC_##L03, KC_##L04, KC_##L05, KC_##L06, KC_##M0, KC_##R00, KC_##R01, KC_##R02, KC_##R03, KC_##R04, KC_##R05, KC_##R06, \
    KC_##L10, KC_##L11, KC_##L12, KC_##L13, KC_##L14, KC_##L15, KC_##L16, KC_##M1, KC_##R10, KC_##R11, KC_##R12, KC_##R13, KC_##R14, KC_##R15, KC_##R16, \
    KC_##L20, KC_##L21, KC_##L22, KC_##L23, KC_##L24, KC_##L25, KC_##L26, KC_##M2, KC_##R20, KC_##R21, KC_##R22, KC_##R23, KC_##R24, KC_##R25, KC_##R26, \
    KC_##L30, KC_##L31, KC_##L32, KC_##L33, KC_##L34, KC_##L35, KC_##L36, KC_##M3, KC_##R30, KC_##R31, KC_##R32, KC_##R33, KC_##R34, KC_##R35, KC_##R36, \
    KC_##L40, KC_##L41, KC_##L42, KC_##L43, KC_##L44, KC_##L45, KC_##L46, KC_##M4, KC_##R40, KC_##R41, KC_##R42, KC_##R43, KC_##R44, KC_##R45, KC_##R46 \
    )

#define _QWERTY 0
#define _FAKENEO 1
#define _SWAPCTRLALT 2
#define _FUNCTION 11
#define _CURSOR 12
#define _NUMPAD 13
#define _FAKENUMPAD 14

enum custom_keycodes {
  QWERTY = SAFE_RANGE,
  FUNCTION,
  NUMPAD,
  CURSOR,
  MOD3Y,
};

// Fillers to make layering more clear
#define KC_     KC_TRNS
#define KC_FN   TT(_FUNCTION)
#define KC_NMPD TT(_FAKENUMPAD)
#define KC_NMPP TG(_NUMPAD)
#define KC_CUR  TT(_CURSOR)
#define KC_CURP TG(_CURSOR)
#define KC_NEO  TG(_FAKENEO)
#define KC_T_CA TG(_SWAPCTRLALT)
#define KC_RSET RESET
#define KC_MD3Y MOD3Y


const uint16_t PROGMEM keymaps[][MATRIX_ROWS][MATRIX_COLS] = {
    [_QWERTY] = LAYOUT_ortho_5x15_kc(
      //--+----+----+----+----+----+----+----+----+----+----+----+----+----+----.
      ESC, F1,  F2,  F3,  F4,  F5,  F6,      ,F7,  F8,  F9,  F10, F11, F12, PSCR,
      //--+----+----+----+----+----+----+----+----+----+----+----+----+----+----|
      TAB, Q,   W,   E,   R,   T,       ,    ,    ,Y,   U,   I,   O,   P,   LBRC,
      //--+----+----+----+----+----+----+----+----+----+----+----+----+----+----|
      CAPS,A,   S,   D,   F,   G,       ,    ,    ,H,   J,   K,   L,   SCLN,MD3Y,
      //--+----+----+----+----+----+----+----+----+----+----+----+----+----+----|
      LSFT,Z,   X,   C,   V,   B,   DEL,     ,BSPC,N,   M,   COMM,DOT, SLSH,RSFT,
      //--+----+----+----+----+----+----+----+----+----+----+----+----+----+----|
      FN,  NMPD,LCTL,LALT,ENT, NMPD,    ,    ,    ,CUR, SPC, RALT,RCTL,CUR, FN
      //--+----+----+----+----+----+----+----+----+----+----+----+----+----+----'
    ),
    [_CURSOR] = LAYOUT_ortho_5x15_kc(
      //--+----+----+----+----+----+----+----+----+----+----+----+----+----+----.
          ,    ,    ,    ,    ,    ,    ,    ,    ,    ,    ,    ,    ,    ,    ,
      //--+----+----+----+----+----+----+----+----+----+----+----+----+----+----|
          ,PGUP,BSPC, UP ,DEL ,PGDN,    ,    ,    ,    ,    ,    ,    ,    ,    ,
      //--+----+----+----+----+----+----+----+----+----+----+----+----+----+----|
          ,HOME,LEFT,DOWN,RGHT,END,     ,    ,    ,    ,    ,    ,    ,    ,    ,
      //--+----+----+----+----+----+----+----+----+----+----+----+----+----+----|
          ,    ,    ,    ,    ,    ,    ,    ,    ,    ,    ,    ,    ,    ,    ,
      //--+----+----+----+----+----+----+----+----+----+----+----+----+----+----|
          ,    ,    ,    ,    ,    ,    ,    ,    ,    ,    ,    ,    ,    ,
      //--+----+----+----+----+----+----+----+----+----+----+----+----+----+----'
    ),
    [_FAKENUMPAD] = LAYOUT_ortho_5x15_kc(
      //--+----+----+----+----+----+----+----+----+----+----+----+----+----+----.
          ,    ,    ,    ,    ,    ,    ,    ,    ,    ,    ,    ,    ,    ,    ,
      //--+----+----+----+----+----+----+----+----+----+----+----+----+----+----|
          ,    ,    ,    ,    ,    ,    ,    ,    ,    , 7  , 8  , 9  ,PPLS,    ,
      //--+----+----+----+----+----+----+----+----+----+----+----+----+----+----|
          ,    ,    ,    ,    ,    ,    ,    ,    ,    , 4  , 5  , 6  ,PEQL,    ,
      //--+----+----+----+----+----+----+----+----+----+----+----+----+----+----|
          ,    ,    ,    ,    ,    ,    ,    ,    ,    , 1  , 2  , 3  ,PENT,    ,
      //--+----+----+----+----+----+----+----+----+----+----+----+----+----+----|
          ,    ,    ,    ,    ,    ,    ,    ,    ,    , 0  ,PCMM,PDOT,PCMM,
      //--+----+----+----+----+----+----+----+----+----+----+----+----+----+----'
    ),
    [_NUMPAD] = LAYOUT_ortho_5x15_kc(
      //--+----+----+----+----+----+----+----+----+----+----+----+----+----+----.
          ,    ,    ,    ,    ,    ,    ,    ,    ,    ,    ,    ,    ,    ,    ,
      //--+----+----+----+----+----+----+----+----+----+----+----+----+----+----|
          ,    ,    ,    ,    ,    ,    ,    ,    ,    ,P7,  P8,  P9,  PPLS,    ,
      //--+----+----+----+----+----+----+----+----+----+----+----+----+----+----|
          ,    ,    ,    ,    ,    ,    ,    ,    ,    ,P4,  P5,  P6,  PEQL,    ,
      //--+----+----+----+----+----+----+----+----+----+----+----+----+----+----|
          ,    ,    ,    ,    ,    ,    ,    ,    ,    ,P1,  P2,  P3,  PENT,    ,
      //--+----+----+----+----+----+----+----+----+----+----+----+----+----+----|
          ,    ,    ,    ,    ,    ,    ,    ,    ,    ,P0,  PCMM,PDOT,PCMM,
      //--+----+----+----+----+----+----+----+----+----+----+----+----+----+----'
    ),
    [_FAKENEO] = LAYOUT_ortho_5x15_kc(
      //--+----+----+----+----+----+----+----+----+----+----+----+----+----+----.
          ,    ,    ,    ,    ,    ,    ,    ,    ,    ,    ,    ,    ,    ,    ,
      //--+----+----+----+----+----+----+----+----+----+----+----+----+----+----|
          ,X   ,V   ,L   ,C   ,W   ,    ,    ,    ,K   ,H   ,G   ,F   ,Q   ,    ,
      //--+----+----+----+----+----+----+----+----+----+----+----+----+----+----|
          ,U   ,I   ,A   ,E   ,O   ,    ,    ,    ,S   ,N   ,R   ,T   ,D   ,Z   ,
      //--+----+----+----+----+----+----+----+----+----+----+----+----+----+----|
          ,LBRC,SCLN,QUOT,P   ,Y   ,    ,    ,    ,B   ,M   ,    ,    ,J   ,    ,
      //--+----+----+----+----+----+----+----+----+----+----+----+----+----+----|
          ,    ,    ,    ,    ,    ,    ,    ,    ,    ,    ,    ,    ,    ,
      //--+----+----+----+----+----+----+----+----+----+----+----+----+----+----'
    ),
    [_SWAPCTRLALT] = LAYOUT_ortho_5x15_kc(
      //--+----+----+----+----+----+----+----+----+----+----+----+----+----+----.
          ,    ,    ,    ,    ,    ,    ,    ,    ,    ,    ,    ,    ,    ,    ,
      //--+----+----+----+----+----+----+----+----+----+----+----+----+----+----|
          ,    ,    ,    ,    ,    ,    ,    ,    ,    ,    ,    ,    ,    ,    ,
      //--+----+----+----+----+----+----+----+----+----+----+----+----+----+----|
          ,    ,    ,    ,    ,    ,    ,    ,    ,    ,    ,    ,    ,    ,    ,
      //--+----+----+----+----+----+----+----+----+----+----+----+----+----+----|
          ,    ,    ,    ,    ,    ,    ,    ,    ,    ,    ,    ,    ,    ,    ,
      //--+----+----+----+----+----+----+----+----+----+----+----+----+----+----|
          ,    ,LALT,LCTL,    ,    ,    ,    ,    ,    ,    ,RCTL,RALT,    ,
      //--+----+----+----+----+----+----+----+----+----+----+----+----+----+----'
    ),
    [_FUNCTION] = LAYOUT_ortho_5x15_kc(
      //--+----+----+----+----+----+----+----+----+----+----+----+----+----+----.
          ,    ,    ,BTN3,    ,    ,    ,    ,    ,    ,    ,    ,    ,    ,    ,
      //--+----+----+----+----+----+----+----+----+----+----+----+----+----+----|
      RSET,    ,BTN1,MS_U,BTN2,    ,    ,    ,    ,    ,MNXT,VOLD,VOLU,MPLY,MUTE,
      //--+----+----+----+----+----+----+----+----+----+----+----+----+----+----|
          ,NEO ,MS_L,MS_D,MS_R,    ,NEO ,    ,NEO ,    ,    ,    ,    ,NEO ,    ,
      //--+----+----+----+----+----+----+----+----+----+----+----+----+----+----|
          ,   ,     ,    ,    ,    ,    ,    ,    ,    ,    ,    ,    ,    ,    ,
      //--+----+----+----+----+----+----+----+----+----+----+----+----+----+----|
          ,    ,T_CA,T_CA,    ,NMPP,    ,    ,    ,CURP,    ,T_CA,T_CA,    ,
      //--+----+----+----+----+----+----+----+----+----+----+----+----+----+----'
  ),
};

uint8_t mod3y_depressed = 0;
uint8_t mod3y_other = 0;

bool process_record_user(uint16_t keycode, keyrecord_t *record) {
  switch (keycode) {
    case MOD3Y:
      if (record->event.pressed) {
        mod3y_depressed = 1;
        mod3y_other = 0;
      } else {
        mod3y_depressed = 0;
        if (mod3y_other) {
          unregister_code16(KC_NUHS);
        }
        else {
          register_code16(KC_QUOT);
          unregister_code16(KC_QUOT);
        }
      }
      return false;

    default:
      if (record->event.pressed) {
        if (mod3y_depressed && !mod3y_other) {
          register_code16(KC_NUHS);
          mod3y_other = 1;
        }
      }
  }
  return true;
}
